<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!--è¿™é‡Œæ˜¯çº¯AIå†™çš„Demo-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LayerKit - å›¾ç‰‡åˆ†å±‚å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        h1 { margin-bottom: 20px; }
        .upload-area { border: 2px dashed #999; padding: 40px; text-align: center; cursor: pointer; margin-bottom: 20px; }
        .upload-area:hover { background: #f9f9f9; }
        #fileInput { display: none; }
        .btn { background: #4CAF50; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; }
        .btn:hover { background: #45a049; }
        .loading { display: none; text-align: center; margin: 20px 0; }
        .error { display: none; background: #ffebee; color: #c62828; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .result { display: none; margin-top: 20px; }
        .info { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px; }
        .search-form { margin-bottom: 20px; }
        .search-form input { padding: 8px; width: 300px; border: 1px solid #ddd; border-radius: 4px; }
        .layers-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .layer-item { border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #fafafa; }
        .layer-item h3 { margin-bottom: 10px; color: #333; }
        .layer-item img, .layer-item canvas { width: 100%; height: auto; max-width: 100%; border: 1px solid #ccc; background: repeating-conic-gradient(#ddd 0% 25%, #fff 0% 50%) 50% / 20px 20px; display: block; }
        .layer-info { margin-top: 10px; font-size: 14px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ LayerKit - å›¾ç‰‡åˆ†å±‚å·¥å…·</h1>
        
        <!-- MD5æœç´¢ -->
        <div class="search-form">
            <input type="text" id="md5Input" placeholder="è¾“å…¥å›¾ç‰‡MD5æŸ¥è¯¢...">
            <button class="btn" onclick="searchByMD5()">æŸ¥è¯¢</button>
        </div>

        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            <div>ğŸ“¤</div>
            <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</p>
            <p>æ”¯æŒ JPEGã€PNG æ ¼å¼ï¼Œæœ€å¤§ 10MB</p>
            <input type="file" id="fileInput" accept="image/jpeg,image/png,image/jpg">
            <div>
                <label><input type="checkbox" id="maxForegroundOnly"> ä»…ä¿ç•™æœ€å¤§å‰æ™¯åŒºåŸŸ</label>
            </div>
        </div>

        <!-- åŠ è½½ä¸­ -->
        <div class="loading" id="loading">
            <p>æ­£åœ¨å¤„ç†å›¾ç‰‡...</p>
        </div>

        <!-- é”™è¯¯æç¤º -->
        <div class="error" id="error"></div>

        <!-- ç»“æœå±•ç¤º -->
        <div class="result" id="result">
            <div class="info" id="info"></div>
            <div class="layers-grid" id="layersGrid"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1';
        let uploadStartTime = null;

        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        
        fileInput.addEventListener('change', handleFileSelect);
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        });

        function handleFileSelect() {
            const file = fileInput.files[0];
            if (!file) return;

            if (!file.type.match('image/(jpeg|png|jpg)')) {
                showError('è¯·é€‰æ‹© JPEG æˆ– PNG æ ¼å¼çš„å›¾ç‰‡');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showError('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 10MB');
                return;
            }

            uploadImage(file);
        }

        async function uploadImage(file) {
            hideError();
            showLoading();
            hideResult();
            uploadStartTime = Date.now();

            const formData = new FormData();
            formData.append('image', file);
            
            const maxForegroundOnly = document.getElementById('maxForegroundOnly').checked;
            if (maxForegroundOnly) {
                formData.append('max_foreground_only', 'true');
            }

            try {
                const response = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'ä¸Šä¼ å¤±è´¥');
                }

                displayResult(result.data, file);
            } catch (error) {
                showError(error.message);
            } finally {
                hideLoading();
            }
        }

        async function searchByMD5() {
            const md5 = document.getElementById('md5Input').value.trim();
            if (!md5) {
                showError('è¯·è¾“å…¥MD5å€¼');
                return;
            }

            hideError();
            showLoading();
            hideResult();

            try {
                const response = await fetch(`${API_BASE}/layer/${md5}`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message || 'æŸ¥è¯¢å¤±è´¥');
                }

                displayResult(result.data, null);
            } catch (error) {
                showError(error.message);
            } finally {
                hideLoading();
            }
        }

        function displayResult(data, file) {
            const duration = uploadStartTime ? ((Date.now() - uploadStartTime) / 1000).toFixed(2) + 's' : 'æ¥è‡ªç¼“å­˜';
            uploadStartTime = null;

            document.getElementById('info').innerHTML = `
                <p><strong>MD5:</strong> ${data.md5}</p>
                <p><strong>å°ºå¯¸:</strong> ${data.width} Ã— ${data.height}</p>
                <p><strong>å¤„ç†æ—¶é—´:</strong> ${duration}</p>
                <p><strong>å›¾å±‚æ•°é‡:</strong> ${data.layers.length}</p>
            `;

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    renderLayers(e.target.result, data);
                };
                reader.readAsDataURL(file);
            } else {
                renderMasksOnly(data);
            }

            showResult();
        }

        function renderLayers(imageSrc, data) {
            const grid = document.getElementById('layersGrid');
            grid.innerHTML = '';

            data.layers.forEach((layer, index) => {
                const item = document.createElement('div');
                item.className = 'layer-item';
                
                const title = document.createElement('h3');
                title.textContent = `${layer.type === 'foreground' ? 'å‰æ™¯' : 'èƒŒæ™¯'} - æ™¯æ·± ${index + 1}`;
                item.appendChild(title);

                const canvas = document.createElement('canvas');
                const img = new Image();
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    
                    // ç»˜åˆ¶åŸå›¾
                    ctx.drawImage(img, 0, 0);
                    
                    // åº”ç”¨mask
                    const maskImg = new Image();
                    maskImg.onload = function() {
                        const maskCanvas = document.createElement('canvas');
                        maskCanvas.width = img.width;
                        maskCanvas.height = img.height;
                        const maskCtx = maskCanvas.getContext('2d');
                        maskCtx.drawImage(maskImg, 0, 0);
                        
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const maskData = maskCtx.getImageData(0, 0, canvas.width, canvas.height);
                        
                        // ä½¿ç”¨maskçš„alphaé€šé“ä½œä¸ºåŸå›¾çš„alpha
                        for (let i = 0; i < imageData.data.length; i += 4) {
                            // maskæ˜¯ç°åº¦å›¾ï¼Œä»»æ„é€šé“éƒ½å¯ä»¥ä½œä¸ºalphaå€¼
                            imageData.data[i + 3] = maskData.data[i];
                        }
                        
                        ctx.putImageData(imageData, 0, 0);
                    };
                    maskImg.src = 'data:image/png;base64,' + layer.mask;
                };
                img.src = imageSrc;
                
                item.appendChild(canvas);

                const info = document.createElement('div');
                info.className = 'layer-info';
                const bbox = layer.bounding_box;
                info.innerHTML = `
                    <p>ç½®ä¿¡åº¦: ${(layer.confidence * 100).toFixed(1)}%</p>
                    <p>åŒºåŸŸ: ${bbox.width} Ã— ${bbox.height}</p>
                    <p>ä½ç½®: (${bbox.x}, ${bbox.y})</p>
                `;
                item.appendChild(info);

                grid.appendChild(item);
            });
        }

        function renderMasksOnly(data) {
            const grid = document.getElementById('layersGrid');
            grid.innerHTML = '';

            data.layers.forEach((layer, index) => {
                const item = document.createElement('div');
                item.className = 'layer-item';
                
                const title = document.createElement('h3');
                title.textContent = `${layer.type === 'foreground' ? 'å‰æ™¯' : 'èƒŒæ™¯'} - æ™¯æ·± ${index + 1}`;
                item.appendChild(title);

                const img = document.createElement('img');
                img.src = 'data:image/png;base64,' + layer.mask;
                item.appendChild(img);

                const info = document.createElement('div');
                info.className = 'layer-info';
                const bbox = layer.bounding_box;
                info.innerHTML = `
                    <p>ç½®ä¿¡åº¦: ${(layer.confidence * 100).toFixed(1)}%</p>
                    <p>åŒºåŸŸ: ${bbox.width} Ã— ${bbox.height}</p>
                    <p>ä½ç½®: (${bbox.x}, ${bbox.y})</p>
                    <p style="color: #999;">ç¼“å­˜æŸ¥è¯¢æ— åŸå›¾</p>
                `;
                item.appendChild(info);

                grid.appendChild(item);
            });
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showResult() {
            document.getElementById('result').style.display = 'block';
        }

        function hideResult() {
            document.getElementById('result').style.display = 'none';
        }

        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = 'âŒ ' + message;
            errorEl.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        document.getElementById('md5Input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchByMD5();
            }
        });
    </script>
</body>
</html>
